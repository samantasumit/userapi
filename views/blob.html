<html ng-app="myApp">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ"
    crossorigin="anonymous">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/components/core-min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io-stream/0.9.1/socket.io-stream.js"></script>


<body ng-controller="myCtrl">
    <div class="container" style="height: 100%; color: #373a3c; display: flex; flex-direction: column;">
        <div style="display: flex; flex-direction: column; margin: 15px auto;">
            <input id="file" type="file">
        </div>
        <button type="button" class="btn btn-primary" ng-click="send()" ng-style="{ 'margin-top' : isStarted ? '0px' : '15px auto' }"
            style="width: 100px; margin: 15px auto; margin-top: 0px">
            Upload
        </button>
        <div class="progress">
            <div id="progress" class="progress-bar progress-bar-striped progress-bar-animated" style="width:0%"></div>
        </div>
    </div>

    <script type="text/javascript">
        var app = angular.module('myApp', []);
        app.controller('myCtrl', ['$scope', '$http', '$timeout', '$interval', function ($scope, $http, $timeout, $interval) {

            var socket = io('http://localhost:8081/chat');

            socket.on('connection', function (data) {
                console.log("Connected");
            });

            $scope.progress = 0;
            $scope.file = null;

            $scope.send = function () {

                var file = $('#file')[0].files[0];
                if (!file) {
                    return;
                }

                $scope.progress = 0;
                var stream = ss.createStream();

                ss(socket).emit('upload', stream, {
                    name: file.name,
                    size: file.size
                });

                var blobStream = ss.createBlobReadStream(file);
                var size = 0;
                blobStream.on('data', (chunk) => {
                    size += chunk.length;
                    console.log('Uploading ' + size + ' / ' + file.size);
                    $timeout(function () {
                        $scope.progress = (size / file.size) * 100;
                        $('#progress').css('width', $scope.progress + "%");
                    });
                });
                blobStream.pipe(stream);
            }

        }]);
    </script>
</body>

</html>